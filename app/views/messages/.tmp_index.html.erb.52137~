<%= session.inspect %>
<%= @search.inspect%>
<% for message in @messages %>
<%= message.id %>
<% end %>
<div id="noprint">
<%if @np%>
	<%= link_to 'печать', "messages?#{('search=' + params[:search] + '&') if params[:search]}print=" %>
	<%= link_to 'Зарегистрировать новое входящее', new_message_path %>
	
	<h1><%= @h1%></h1>
	<%= link_to '<b>сбросить фильтры</b>', "messages?filter=0" %><br/>
	<b>фильтр года</b>
	<% for year in @years %>
  <%= link_to year, "messages?#{('search=' + params[:search] + '&') if params[:search]}year=#{year.to_s}" %>
  
  
  <% end %><br/>
  
	<b>фильтр статуса исполнения</b>
	<%= link_to "Завершенные(#{@counts[1]})", :action => 'index', :status => "complete"%>
	<%= link_to "В работе(#{@counts[0]})", :action => 'index', :status => "incomplete"%>
	<% form_tag messages_path, :method => 'get' do %>
	  <p>
	    <%= text_field_tag :search, params[:search] %>
		<%= text_field_tag :status, params[:status], :type => 'hidden'%>
	    <%= submit_tag "Поиск", :name => nil %>
	  </p>
	<% end %>
	

<%else%>
	<%= link_to_function("Напечатать", "javascript:print()")%>
	<%= link_to 'отменить печать', "messages?#{('search=' + params[:search] + '&') if params[:search]}" %>
<%end%>
<%= will_paginate @messages %>

</div>
<table border=1>
  	<tr>
	    <th>Автор</th>
		<%if @np%>
	    <th>Входящий номер</th>
	    <th>Исходящий номер</th>
		<%else%>
		<th>Номера</th>
		<%end%>
	    <th>Тема</th>
	    <%if @np%>
		<th>Исполнитель</th>
		<th>Действия</th>
		<th>Счетчик действий</th>
		<%end%>
	</tr>
	<% @messages.each do |message| %>
	<tr>    
		<%if @np%>
		<td width=13% >
		<%else%>
		<td width=30% >
		<%end%>
		<div class="
			<%= 
			case (Date.today - message.created_at.to_date)
		        when 0..7 then "normal"
		        when 7..14 then "close"
		        when 14..10000 then "dead"
			end            
	        %>
		    ">
			<%=
			if message.agent_name        
				message.agent.sname + "<br/>" 
			else
				"Не заполнено"
			end
			%>
			<%= message.org.name if message.org%>
		</div>
		</td>
		<td width=9%>
    		3-1-09/<%=h message.number %> <br/>
  			<small><%=h message.created_at.strftime("%d.%m.%y") %><br/></small>
  		<%if @np%></td><td width=9%><%end%> 
  		<%=h message.int_number%> 
  		</td>
		<td> <%=h message.subject %>
			<a href="uploads/message.<%=message.id%>.pdf">+</a><br/ ></td>
		<%if @np%>
		<td><%=h Agent.find(:first, :conditions => "id = '#{message.redirects[-1].agent_id}'").sname if message.redirects.size > 0 %></td>
		
		<td>
		<%= link_to image_tag ('22.png',:title=> 'Редактировать'), edit_message_path(message) %>
		<%= link_to image_tag ('9.png',:title=> 'Карточка'), message %>
		
		<a href="/messages/forward/<%=message.id%>" title='Направить для работы' onclick="Modalbox.show(this.href, {title: this.title, width: 600}); return false;"><img alt="17" src="/images/17.png" title="Направить" /></a>
		<a href="/messages/mfu/<%=message.id%>" title='Прикрепить копию письма' onclick="Modalbox.show(this.href, {title: this.title, width: 600}); return false;"><img alt="20" src="/images/20.png" title="Прикрепить файл" /></a>
		</td>
		<td><%=h message.cards.size%></td>
		<%end%>
	</tr>
	<% end %>
</table>
<br />
<div id="noprint">
<%= will_paginate @messages %>
<%= link_to 'Зарегистрировать новое входящее', new_message_path %>
</div>